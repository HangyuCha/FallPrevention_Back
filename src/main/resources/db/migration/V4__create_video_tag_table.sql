DECLARE
    v_cnt NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_cnt FROM user_tables WHERE table_name = 'VIDEO_TAG';
    IF v_cnt = 0 THEN
        EXECUTE IMMEDIATE q'{
            CREATE TABLE VIDEO_TAG (
                ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                VIDEO_ID NUMBER(19) NOT NULL,
                TAG_NAME VARCHAR2(255) NOT NULL,
                CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT FK_VIDEO_TAG_FILE FOREIGN KEY (VIDEO_ID) REFERENCES VIDEO_FILE(ID) ON DELETE CASCADE
            )
        }';
    END IF;

    SELECT COUNT(*) INTO v_cnt FROM user_tab_cols WHERE table_name = 'VIDEO_TAG' AND column_name = 'CREATED_AT';
    IF v_cnt = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE VIDEO_TAG ADD CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP';
    END IF;

    SELECT COUNT(*) INTO v_cnt FROM user_indexes WHERE table_name = 'VIDEO_TAG' AND index_name = 'IDX_VIDEO_TAG_VIDEO';
    IF v_cnt = 0 THEN
        EXECUTE IMMEDIATE 'CREATE INDEX IDX_VIDEO_TAG_VIDEO ON VIDEO_TAG(VIDEO_ID)';
    END IF;
END;
/
